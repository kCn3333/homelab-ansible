---
# â˜¸ï¸ K3s cluster installation - master first, then workers
- name: ğŸ¯ Install K3s Master
  hosts: masters
  become: yes
  tasks:
    - name: ğŸ” Check if K3s is already installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_installed

    - name: ğŸ“¥ Download and install K3s on master
      shell: |
        curl -sfL https://get.k3s.io | sh -s - server \
          --write-kubeconfig-mode 644 \
          --node-name {{ inventory_hostname }}
      when: not k3s_installed.stat.exists

    - name: â³ Wait for K3s to start
      wait_for:
        port: 6443
        delay: 5
        timeout: 120

    - name: ğŸ”‘ Get token from master
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_token

    - name: ğŸ’¾ Save token to fact
      set_fact:
        k3s_master_token: "{{ k3s_token.content | b64decode | trim }}"

    - name: ğŸ“‹ Fetch kubeconfig
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: ./k3s-kubeconfig.yaml
        flat: yes

    - name: ğŸ“Š Display K3s status
      command: kubectl get nodes
      register: nodes_output

    - debug:
        var: nodes_output.stdout_lines

- name: ğŸ”— Join workers to cluster
  hosts: workers
  become: yes
  tasks:
    - name: ğŸ” Check if K3s is already installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_installed

    - name: ğŸ“¥ Install K3s agent on workers
      shell: |
        curl -sfL https://get.k3s.io | K3S_URL=https://{{ hostvars[groups['masters'][0]].ansible_host }}:6443 \
          K3S_TOKEN={{ hostvars[groups['masters'][0]].k3s_master_token }} \
          sh -s - agent --node-name {{ inventory_hostname }}
      when: not k3s_installed.stat.exists

- name: âœ… Verify cluster
  hosts: masters
  become: yes
  tasks:
    - name: â³ Wait for workers to join
      pause:
        seconds: 15

    - name: ğŸ” Check status of all nodes
      command: kubectl get nodes
      register: final_nodes

    - name: ğŸ“Š Display final nodes
      debug:
        var: final_nodes.stdout_lines

    - name: ğŸ“ Display cluster information
      debug:
        msg: |
          âœ… K3s cluster installed successfully!
          ğŸ“ Kubeconfig saved at: ./k3s-kubeconfig.yaml
          
          ğŸš€ To use kubectl locally:
          export KUBECONFIG=$(pwd)/k3s-kubeconfig.yaml
          kubectl get nodes
