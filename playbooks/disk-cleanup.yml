---
- name: Clean up disk space on nodes
  hosts: all
  gather_facts: true
  vars:
    log_retention_days: 30
    clean_docker: true
    clean_package_cache: true
    custom_cleanup_paths: []
  
  tasks:
    - name: Get disk usage before cleanup
      ansible.builtin.shell: df -h / | tail -1 | awk '{print $5}'
      register: disk_before
      changed_when: false

    - name: Find and remove old log files
      ansible.builtin.find:
        paths:
          - /var/log
          - /var/log/journal
        age: "{{ log_retention_days }}d"
        recurse: true
        file_type: file
      register: old_logs

    - name: Remove old log files
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_logs.files }}"
      when: old_logs.files | length > 0
      ignore_errors: true

    - name: Clean journalctl logs
      ansible.builtin.command: journalctl --vacuum-time={{ log_retention_days }}d
      changed_when: true
      ignore_errors: true

    - name: Clean apt cache (Debian/Ubuntu)
      ansible.builtin.apt:
        autoclean: true
        autoremove: true
      when:
        - ansible_facts['os_family'] == "Debian"
        - clean_package_cache | bool

    - name: Clean yum cache (RHEL/CentOS)
      ansible.builtin.command: yum clean all
      when:
        - ansible_facts['os_family'] == "RedHat"
        - clean_package_cache | bool
      changed_when: true

    - name: Check if Docker is installed
      ansible.builtin.service_facts:

    - name: Docker system prune
      ansible.builtin.command: docker system prune -af --volumes
      when:
        - clean_docker | bool
        - ansible_facts.services['docker.service'] is defined
      changed_when: true
      register: docker_prune
      ignore_errors: true

    - name: Display Docker prune results
      ansible.builtin.debug:
        var: docker_prune.stdout_lines
      when:
        - clean_docker | bool
        - ansible_facts.services['docker.service'] is defined
        - docker_prune.stdout_lines is defined

    - name: Clean temporary files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/*
        - /var/tmp/*
      ignore_errors: true

    - name: Clean custom paths
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop: "{{ custom_cleanup_paths }}"
      when: custom_cleanup_paths | length > 0
      ignore_errors: true

    - name: Get disk usage after cleanup
      ansible.builtin.shell: df -h / | tail -1 | awk '{print $5}'
      register: disk_after
      changed_when: false

    - name: Display cleanup summary
      ansible.builtin.debug:
        msg:
          - "{{ inventory_hostname }} Cleanup Summary"
          - "Disk usage before: {{ disk_before.stdout }}"
          - "Disk usage after: {{ disk_after.stdout }}"
          - "Old logs removed: {{ old_logs.files | length }}"

    - name: Calculate space freed
      ansible.builtin.set_fact:
        space_freed: "{{ disk_before.stdout | replace('%', '') | int - disk_after.stdout | replace('%', '') | int }}"

    - name: Display space freed
      ansible.builtin.debug:
        msg: "Freed approximately {{ space_freed }}% disk space on {{ inventory_hostname }}"
        