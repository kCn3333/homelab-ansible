---
- name: Wake up nodes via Wake-on-LAN
  hosts: all
  gather_facts: false
  vars:
    wol_timeout: 120
    wol_delay: 10
  tasks:
    - name: Verify mac_address is defined
      ansible.builtin.assert:
        that:
          - mac_address is defined
          - mac_address | length > 0
        fail_msg: "mac_address must be defined for {{ inventory_hostname }}"
      delegate_to: localhost
      run_once: false

    - name: Send Wake-on-LAN magic packet
      ansible.builtin.command: "wakeonlan {{ mac_address }}"
      delegate_to: localhost
      changed_when: true
      register: wol_result
    - name: Display WoL status
      ansible.builtin.debug:
        msg: "Magic packet sent to {{ inventory_hostname }} ({{ mac_address }})"

    - name: Wait for SSH to become available
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 22
        state: started
        delay: "{{ wol_delay }}"
        timeout: "{{ wol_timeout }}"
      delegate_to: localhost
    - name: Verify host is reachable
      ansible.builtin.ping:
      retries: 3
      delay: 5
