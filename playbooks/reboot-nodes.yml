---
- name: Reboot nodes and wait for them to come back
  hosts: all
  gather_facts: true
  become: true
  vars:
    reboot_timeout: 300
    reboot_delay: 0
  
  tasks:
    - name: Check system uptime before reboot
      ansible.builtin.command: uptime
      register: uptime_before
      changed_when: false

    - name: Display pre-reboot uptime
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }} uptime before reboot: {{ uptime_before.stdout }}"

    - name: Reboot the system
      ansible.builtin.shell: sleep {{ reboot_delay }} && /sbin/shutdown -r now "Reboot initiated by Ansible"
      async: 1
      poll: 0
      become: true

    - name: Wait for system to go down
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 22
        state: stopped
        delay: 5
        timeout: 60
      delegate_to: localhost
      become: false

    - name: Wait for system to come back
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 22
        state: started
        delay: 30
        timeout: "{{ reboot_timeout }}"
      delegate_to: localhost
      become: false

    - name: Wait for system to fully boot
      ansible.builtin.wait_for_connection:
        delay: 10
        timeout: "{{ reboot_timeout }}"

    - name: Gather facts after reboot
      ansible.builtin.setup:

    - name: Verify system is back online
      ansible.builtin.ping:

    - name: Check system uptime after reboot
      ansible.builtin.command: uptime
      register: uptime_after
      changed_when: false

    - name: Display post-reboot status
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }} is back online. New uptime: {{ uptime_after.stdout }}"
